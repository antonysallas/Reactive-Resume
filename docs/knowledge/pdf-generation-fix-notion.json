{
  "parent": {
    "database_id": "1fba94d4-8e10-81d0-8d9d-fd8dd1ed9355"
  },
  "properties": {
    "Page": {
      "title": [
        {
          "text": {
            "content": "PDF Generation Fix: 307 HTTPS Redirect Resolution"
          }
        }
      ]
    },
    "Tags": {
      "multi_select": [
        {
          "name": "Bug"
        }
      ]
    },
    "Owner": {
      "people": [
        {
          "object": "user",
          "id": "f1404696-f061-46bc-a5f3-674a6b166001"
        }
      ]
    }
  },
  "children": [
    {
      "object": "block",
      "type": "heading_1",
      "heading_1": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "PDF Generation Fix: 307 HTTPS Redirect Resolution"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "paragraph",
      "paragraph": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Date: May 22, 2025\nStatus: Fix Implemented\nSeverity: High - PDF generation completely broken\nEnvironment: Docker/Podman containerized setup"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "heading_2",
      "heading_2": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Problem Description"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "paragraph",
      "paragraph": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "PDF generation fails with SSL protocol error. Chrome browser container successfully accesses "
            }
          },
          {
            "type": "text",
            "text": {
              "content": "http://app:3000/artboard/preview"
            },
            "annotations": {
              "code": true
            }
          },
          {
            "type": "text",
            "text": {
              "content": " but receives a 307 redirect to "
            }
          },
          {
            "type": "text",
            "text": {
              "content": "https://app:3000/artboard/preview"
            },
            "annotations": {
              "code": true
            }
          },
          {
            "type": "text",
            "text": {
              "content": ", which then fails with "
            }
          },
          {
            "type": "text",
            "text": {
              "content": "net::ERR_SSL_PROTOCOL_ERROR"
            },
            "annotations": {
              "code": true
            }
          },
          {
            "type": "text",
            "text": {
              "content": " since the app doesn't serve HTTPS."
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "heading_2",
      "heading_2": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Root Cause Analysis"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "bulleted_list_item",
      "bulleted_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Error Chain: HTTP GET → 307 Redirect → HTTPS GET → SSL Error → chrome-error://chromewebdata/"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "bulleted_list_item",
      "bulleted_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Chrome browserless container logs confirm the server is sending the 307 redirect"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "bulleted_list_item",
      "bulleted_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Issue persists even with NODE_ENV=development and CHROME_IGNORE_HTTPS_ERRORS=true"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "bulleted_list_item",
      "bulleted_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Previous printer service URL replacement logic (localhost → app) was correct"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "heading_2",
      "heading_2": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Investigation Process"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "numbered_list_item",
      "numbered_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Analyzed Chrome browserless container logs - confirmed 307 redirect from server"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "numbered_list_item",
      "numbered_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Checked NestJS main.ts for production middleware (helmet) - found potential cause"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "numbered_list_item",
      "numbered_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Identified helmet middleware with default HSTS configuration as likely cause"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "numbered_list_item",
      "numbered_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Attempted ServeStaticModule configuration changes - caused artboard serving issues, rollback completed"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "heading_2",
      "heading_2": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Applied Solutions"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "numbered_list_item",
      "numbered_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Added CHROME_IGNORE_HTTPS_ERRORS=true to Docker Compose configuration"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "numbered_list_item",
      "numbered_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Set NODE_ENV=development in compose.yml to disable production security middleware"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "numbered_list_item",
      "numbered_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Disabled HSTS headers in helmet configuration to prevent HTTPS enforcement"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "numbered_list_item",
      "numbered_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Added debugging logs to printer service for URL navigation tracking"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "heading_2",
      "heading_2": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Configuration Changes"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "paragraph",
      "paragraph": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "compose.yml environment variables:"
            },
            "annotations": {
              "bold": true
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "code",
      "code": {
        "language": "yaml",
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "NODE_ENV: development\nCHROME_IGNORE_HTTPS_ERRORS: true"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "paragraph",
      "paragraph": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "apps/server/src/main.ts helmet configuration:"
            },
            "annotations": {
              "bold": true
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "code",
      "code": {
        "language": "typescript",
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "app.use(helmet({\n  contentSecurityPolicy: false,\n  hsts: false // Disable HSTS to prevent HTTPS redirects in containers\n}));"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "heading_2",
      "heading_2": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Testing Instructions"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "paragraph",
      "paragraph": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "To apply the fix and test:"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "code",
      "code": {
        "language": "bash",
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "# Rebuild app container with new configuration\npodman compose up --build -d app\n\n# Test PDF generation functionality\n# Monitor logs for debugging output"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "heading_2",
      "heading_2": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Error Logs Reference"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "code",
      "code": {
        "language": "plain text",
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "chrome-1 | browserless.io:ChromiumCDPWebSocketRoute:trace 10.89.0.2 GET: http://app:3000/artboard/preview\nchrome-1 | browserless.io:ChromiumCDPWebSocketRoute:trace 10.89.0.2 307: http://app:3000/artboard/preview\nchrome-1 | browserless.io:ChromiumCDPWebSocketRoute:trace 10.89.0.2 GET: https://app:3000/artboard/preview\nchrome-1 | browserless.io:ChromiumCDPWebSocketRoute:warn 10.89.0.2 \"net::ERR_SSL_PROTOCOL_ERROR\": https://app:3000/artboard/preview\napp-1 | Trace: Error: net::ERR_SSL_PROTOCOL_ERROR at http://app:3000/artboard/preview"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "heading_2",
      "heading_2": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Alternative Solutions (if primary fix fails)"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "bulleted_list_item",
      "bulleted_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Check Express.js trust proxy settings or similar middleware"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "bulleted_list_item",
      "bulleted_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Investigate reverse proxy configuration in container networking"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "bulleted_list_item",
      "bulleted_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Consider serving artboard directly without main app proxy"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "bulleted_list_item",
      "bulleted_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Test with alternative Chrome/Puppeteer configuration"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "heading_2",
      "heading_2": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "Files Modified"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "bulleted_list_item",
      "bulleted_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "compose.yml - Added CHROME_IGNORE_HTTPS_ERRORS and set NODE_ENV to development"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "bulleted_list_item",
      "bulleted_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "apps/server/src/main.ts - Disabled HSTS in helmet configuration"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "bulleted_list_item",
      "bulleted_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "apps/server/src/printer/printer.service.ts - Added debugging logs"
            }
          }
        ]
      }
    },
    {
      "object": "block",
      "type": "bulleted_list_item",
      "bulleted_list_item": {
        "rich_text": [
          {
            "type": "text",
            "text": {
              "content": "docs/knowledge/doc_registry.md - Updated with investigation documentation"
            }
          }
        ]
      }
    }
  ]
}